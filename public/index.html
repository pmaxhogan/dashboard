<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello!</title>
    <style>
        #charts {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
        }

        #charts > * {
            margin: 10px;
        }
    </style>
</head>
<body>
<a href="http://localhost:3000/login/twitter">Auth Twitter</a>
<a href="http://localhost:3000/login/gmail">Auth Gmail</a>
<div id="charts">
</div>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    (async () => {
        const titleCase = (str) => str.replaceAll("_", " ").replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.slice(1).toLowerCase());


        const sources = (await fetch("http://localhost:3000/api/sources").then(response => response.json())).sources;

        const updateFns = [];

        const charts = document.querySelector("#charts");
        const proms = sources.map(async source => {
            const {
                series
            } = await fetch(`http://localhost:3000/api/stats/${source}`).then(response => response.json());
            const subSeries = Object.keys(series);

            const seriesCharts = {};

            for(const subSeriesOne of subSeries) {
                const chartElem = document.createElement("div");
                chartElem.id = `chart-${source}-${subSeriesOne}`;
                charts.appendChild(chartElem);


                const options = {
                    series: [],
                    chart: {
                        type: "area",
                        stacked: false,
                        height: 350,
                        zoom: {
                            type: "x",
                            enabled: true,
                            autoScaleYaxis: true
                        },
                        toolbar: {
                            autoSelected: "zoom"
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    markers: {
                        // size: 3,
                    },
                    title: {
                        text: `${titleCase(source)} Source: ${titleCase(subSeriesOne)}`,
                        align: "left"
                    },
                    stroke: {
                        curve: "straight"
                    },
                    fill: {
                        type: "gradient",
                        gradient: {
                            shadeIntensity: 1,
                            inverseColors: false,
                            opacityFrom: 0.9,
                            opacityTo: 0,
                            stops: [0, 90, 100],
                        },
                    },
                    yaxis: {
                        labels: {
                            formatter: function (val) {
                                return val.toFixed(0);
                            },
                        },
                        title: {
                            text: "Value"
                        },
                    },
                    xaxis: {
                        type: "datetime",
                    },
                    tooltip: {
                        shared: false,
                        y: {
                            formatter: function (val) {
                                return val.toFixed(0)
                            }
                        }
                    }
                };

                const chart = new ApexCharts(chartElem, options);
                chart.render();
                seriesCharts[subSeriesOne] = chart;
            }

            async function update() {
                const {
                    stats,
                    series
                } = await fetch(`http://localhost:3000/api/stats/${source}`).then(response => response.json());

                for(const subSeriesOne of subSeries) {
                    seriesCharts[subSeriesOne].updateSeries(series[subSeriesOne].map(s => ({
                        name: titleCase(s),
                        data: stats.map(stat => [stat.timestamp, stat.stats[subSeriesOne][s]])
                    })));
                }
            }

            updateFns.push(update);
            update();
        });

        await Promise.all(proms);

        setInterval(() => {
            updateFns.forEach(fn => fn());
        }, 30 * 1000);
    })();
</script>
</body>
</html>